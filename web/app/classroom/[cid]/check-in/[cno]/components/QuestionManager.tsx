"use client";
import { useState, useEffect } from "react";
import { db } from "@/lib/firebase";
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy } from "firebase/firestore";
import Link from "next/link";
import { FaEye, FaTrash, FaRegQuestionCircle } from "react-icons/fa";
import Swal from "sweetalert2";

export default function QuestionManager({ cid, cno }: { cid: string; cno: string }) {
    const [questions, setQuestions] = useState<any[]>([]);

    // üîπ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å Firestore
    useEffect(() => {
        if (cid && cno) {
            fetchQuestions();
        }
    }, [cid, cno]);    

    const fetchQuestions = async () => {
        const qRef = collection(db, `classroom/${cid}/checkin/${cno}/question`);
        const snapshot = await getDocs(query(qRef, orderBy("question_no", "asc")));
        const data = snapshot.docs.map((doc) => ({
            qid: doc.id,
            ...doc.data(),
            question_no: Number(doc.data().question_no) || 0, // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Number ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ú‡∏¥‡∏î
        }));

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô set state
        setQuestions(data.sort((a, b) => a.question_no - b.question_no));
    };

    // üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const handleAddQuestion = async () => {
        const { value: newQuestion } = await Swal.fire({
            title: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà",
            input: "textarea",
            inputPlaceholder: "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£...",
            showCancelButton: true,
            confirmButtonText: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
            cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#6c757d",
            inputValidator: (value) => {
                if (!value.trim()) return "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°!";
            }
        });

        if (newQuestion) {
            try {
                // ‚úÖ ‡∏´‡∏≤ `question_no` ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 1)
                const lastQuestionNo = questions.length > 0
                    ? Math.max(...questions.map(q => Number(q.question_no) || 0)) 
                    : 0;

                const newQuestionNo = lastQuestionNo + 1;

                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Number)
                const qRef = collection(db, `classroom/${cid}/checkin/${cno}/question`);
                const docRef = await addDoc(qRef, {
                    question_no: newQuestionNo,
                    question_text: newQuestion,
                    question_show: false
                });

                // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                setQuestions(prev => [...prev, { 
                    qid: docRef.id, 
                    question_no: newQuestionNo, 
                    question_text: newQuestion, 
                    question_show: false 
                }].sort((a, b) => a.question_no - b.question_no));
                
            } catch (error) {
                console.error("Error adding question:", error);
                Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ", "error");
            }
        }
    };

    // üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Show/Hide
    const handleToggleVisibility = async (qid: string, visible: boolean) => {
        const qCollection = collection(db, `classroom/${cid}/checkin/${cno}/question`);

        // üìå ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firestore
        const snapshot = await getDocs(qCollection);
        const allQuestions = snapshot.docs.map((doc) => ({
            qid: doc.id,
            ...doc.data(),
        }));

        // üîπ ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
        const updatePromises = allQuestions.map(async (q) => {
            const qRef = doc(db, `classroom/${cid}/checkin/${cno}/question`, q.qid);
            return updateDoc(qRef, { question_show: false });
        });

        // üîπ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡∏¥‡∏î)
        if (visible) {
            const selectedQRef = doc(db, `classroom/${cid}/checkin/${cno}/question`, qid);
            updatePromises.push(updateDoc(selectedQRef, { question_show: true }));
        }

        // ‚úÖ ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        await Promise.all(updatePromises);

        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡πÉ‡∏ô React
        setQuestions(allQuestions.map((q) => ({
            ...q,
            question_show: q.qid === qid ? visible : false,
        })));
    };

    // üîπ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const handleDelete = async (qid: string) => {
        const result = await Swal.fire({
            title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö",
            text: "‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "‡∏•‡∏ö‡πÄ‡∏•‡∏¢",
            cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
        });

        if (!result.isConfirmed) return;

        try {
            // ‚úÖ ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const qRef = doc(db, `classroom/${cid}/checkin/${cno}/question/${qid}`);
            await deleteDoc(qRef);

            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI (‡πÄ‡∏≠‡∏≤‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)
            let updatedQuestions = questions.filter(q => q.qid !== qid);

            // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ `question_no` ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
            const updatePromises = updatedQuestions.map(async (q, index) => {
                const newQuestionNo = index + 1; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 1 ‡πÉ‡∏´‡∏°‡πà
                const qDocRef = doc(db, `classroom/${cid}/checkin/${cno}/question/${q.qid}`);
                await updateDoc(qDocRef, { question_no: newQuestionNo });

                return { ...q, question_no: newQuestionNo };
            });

            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡πà‡∏≠‡∏ô
            updatedQuestions = await Promise.all(updatePromises);
            setQuestions(updatedQuestions.sort((a, b) => a.question_no - b.question_no));

        } catch (error) {
            console.error("Error deleting question:", error);
            Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ", "error");
        }
    };


    return (
        <div className="mt-6 p-8">
            {/* üîπ ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á Q&A */}
            <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold text-gray-800">Q&A</h2>
                <button className="bg-green-500 text-white px-4 py-2 rounded shadow-md hover:bg-green-600 transition"
                    onClick={handleAddQuestion}>
                    + Add Question
                </button>
            </div>

            {/* ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà */}
            {questions.length > 0 ? (
                <div className="mx-6">
                    <table className="w-full border-collapse">
                        <thead>
                            <tr className="border-b-2 border-gray-500">
                                <th className="p-3 text-left text-black">Question_No</th>
                                <th className="p-3 text-left text-black">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
                                <th className="p-3 text-center text-black">Show Questions</th>
                                <th className="p-3 text-center text-black">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {questions.map((q, index) => (
                                <tr key={q.qid} className="even:bg-gray-100">
                                    <td className="p-3 text-center text-black">{q.question_no}</td>
                                    <td className="p-3 text-black">{q.question_text}</td>
                                    <td className="p-3 text-center text-black">
                                        <input
                                            type="checkbox"
                                            checked={q.question_show}
                                            onChange={() => handleToggleVisibility(q.qid, !q.question_show)}
                                            className="w-5 h-5 cursor-pointer"
                                        />
                                    </td>
                                    <td className="p-3 text-center">
                                        <div className="flex justify-center gap-x-6">
                                            <Link href={`/classroom/${cid}/check-in/${cno}/question/${q.qid}`}>
                                                <button className="text-blue-500 hover:text-blue-700 transition px-3">
                                                    <FaEye size={18} />
                                                </button>
                                            </Link>
                                            <button onClick={() => handleDelete(q.qid)}
                                                className="text-gray-400 hover:text-red-700 transition px-3">
                                                <FaTrash size={18} />
                                            </button>
                                        </div>
                                    </td>

                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

            ) : (
                /* ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á */
                <div className="flex flex-col items-center justify-center bg-gray-100 rounded-lg py-10 shadow-inner">
                    <FaRegQuestionCircle className="w-16 h-16 text-gray-400 mb-4" />
                    <p className="text-gray-600 text-lg font-medium mb-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</p>
                </div>
            )}
        </div>
    );

}
